#!/usr/bin/env zsh
# Git worktree printer with fzf
# Usage: git worktree-print

set -e

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "Error: Not in a git repository" >&2
  exit 1
fi

# Check if fzf is available
if ! command -v fzf > /dev/null 2>&1; then
  echo "Error: fzf is not installed" >&2
  exit 1
fi

# Check worktree count
worktree_count=$(git worktree list | wc -l | tr -d ' ')

if [[ "$worktree_count" -eq 1 ]]; then
  # Only one worktree, use current directory
  worktree=$(git rev-parse --show-toplevel)
else
  # Select a worktree using fzf (sorted by zoxide score)
  worktree=$(git worktree list | awk '{print $1}' | while read dir; do score=$(zoxide query -s "$dir" 2>/dev/null | awk '{print $1}'); [ -n "$score" ] && echo "$score $dir"; done | sort -rn | awk '{print $2}' | fzf +s --preview='git -C {} log --oneline | head -20')

  if [[ -z "$worktree" ]]; then
    echo "No worktree selected" >&2
    exit 1
  fi
fi

# Get current branch in selected worktree
current_branch=$(git -C "$worktree" branch --show-current)

# Get list of recent branches
if command -v git-recently-checkedout-branches > /dev/null 2>&1; then
  recent_branches=$(git -C "$worktree" recently-checkedout-branches 2>/dev/null)
else
  recent_branches=$(git -C "$worktree" branch --sort=-committerdate | sed 's/^[\* ]*//')
fi

# Build branch list with current branch first
branch_list="* * * $current_branch (current)"
if [[ -n "$recent_branches" ]]; then
  # Add other branches, excluding current branch
  branch_list="$branch_list
$(echo "$recent_branches" | grep -v "^$current_branch$" | head -20)"
fi

# Select branch
selected=$(echo "$branch_list" | fzf +s --preview="git -C $worktree log {} --oneline 2>/dev/null | head -20" | awk '{print $4}')

if [[ -z "$selected" ]]; then
  # No selection, exit
  echo "No branch selected" >&2
  exit 1
fi

# Print worktree and branch (if different from current)
if [[ "$selected" != "$current_branch" ]]; then
  printf "%s\t%s\n" "$worktree" "$selected"
else
  echo "$worktree"
fi
