#!/usr/bin/env zsh
# Git worktree switcher with fzf
# Usage: git worktree-switch

set -e

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "Error: Not in a git repository" >&2
  exit 1
fi

# Check if fzf is available
if ! command -v fzf > /dev/null 2>&1; then
  echo "Error: fzf is not installed" >&2
  exit 1
fi

# Select a worktree using fzf (sorted by zoxide score)
worktree=$(git worktree list | awk '{print $1}' | while read dir; do score=$(zoxide query -s "$dir" 2>/dev/null | awk '{print $1}'); [ -n "$score" ] && echo "$score $dir"; done | sort -rn | awk '{print $2}' | fzf +s --preview='git -C {} log --oneline | head -20')

if [[ -n "$worktree" ]]; then
  cd "$worktree"
  exec $SHELL
else
  echo "No worktree selected" >&2
  exit 1
fi
